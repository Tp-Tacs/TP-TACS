<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GamesControllerService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wololo</a> &gt; <a href="index.source.html" class="el_package">com.grupox.wololo.services</a> &gt; <span class="el_source">GamesControllerService.kt</span></div><h1>GamesControllerService.kt</h1><pre class="source lang-java linenums">package com.grupox.wololo.services

import arrow.core.*
import arrow.core.extensions.either.applicative.applicative
import arrow.core.extensions.fx
import arrow.core.extensions.list.traverse.sequence
import com.grupox.wololo.errors.CustomException
import com.grupox.wololo.model.*
import com.grupox.wololo.model.externalservices.GeoRef
import com.grupox.wololo.model.externalservices.TopoData
import com.grupox.wololo.model.helpers.AttackForm
import com.grupox.wololo.model.helpers.GameForm
import com.grupox.wololo.model.helpers.MovementForm
import com.grupox.wololo.model.helpers.TownGeoRef
import org.springframework.stereotype.Service
import com.grupox.wololo.model.repos.RepoGames
import com.grupox.wololo.model.repos.RepoUsers
import org.springframework.beans.factory.annotation.Autowired
import java.util.*

@Service
<span class="fc" id="L22">class GamesControllerService {</span>
    @Autowired
<span class="nc" id="L24">    lateinit var geoRef: GeoRef</span>
    @Autowired
<span class="nc" id="L26">    lateinit var topoData: TopoData</span>

    fun surrender(gameId: Int, userId: Int) {
<span class="nc" id="L29">        val game: Game = RepoGames.getById(gameId).getOrHandle { throw it }</span>
<span class="nc" id="L30">        val user: User = game.getMember(userId).getOrHandle { throw it }</span>

<span class="nc" id="L32">        user.updateGamesLostStats()</span>

<span class="nc bnc" id="L34" title="All 2 branches missed.">        if (game.playerAmount &lt;= 2) {</span>
<span class="nc bnc" id="L35" title="All 4 branches missed.">            game.players.filter { it.id != user.id }.map { it.updateGamesWonStats() }  // Update stats ganadores</span>
<span class="nc" id="L36">            game.status = Status.CANCELED</span>
        }
<span class="nc" id="L38">    }</span>

    fun finishTurn(userId: Int, gameId: Int) {
<span class="fc" id="L41">        val game = RepoGames.getById(gameId).getOrHandle {throw it }</span>
<span class="fc" id="L42">        val user = RepoUsers.getById(userId).getOrHandle {throw it }</span>
<span class="fc" id="L43">        game.finishTurn(user)</span>
<span class="fc" id="L44">    }</span>

    fun moveGauchosBetweenTowns(userId: Int, gameId: Int, movementData: MovementForm) {
<span class="fc" id="L47">        val game = RepoGames.getById(gameId).getOrHandle { throw it }</span>
<span class="fc" id="L48">        val user = RepoUsers.getById(userId).getOrHandle {throw it }</span>
<span class="fc" id="L49">        game.moveGauchosBetweenTowns(user, movementData)</span>
<span class="fc" id="L50">    }</span>

    fun attackTown(userId: Int, gameId: Int, attackData: AttackForm) {
<span class="fc" id="L53">        val game = RepoGames.getById(gameId).getOrHandle { throw it }</span>
<span class="fc" id="L54">        val user = RepoUsers.getById(userId).getOrHandle {throw it }</span>
<span class="nc" id="L55">        game.attackTown(user, attackData)</span>
<span class="nc" id="L56">    }</span>

<span class="nc" id="L58">    fun getProvinces() = geoRef.requestAvailableProvinces().getOrHandle { throw it }</span>

    fun getGame(gameId: Int, userId: Int): Game {
<span class="nc" id="L61">        val user = RepoUsers.getById(userId).getOrHandle { throw it }</span>
<span class="nc" id="L62">        val game = RepoGames.getById(gameId).getOrHandle { throw it }</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if(!game.isParticipating(user)) throw CustomException.Unauthorized.TokenException(&quot;User not participating in this game&quot;) // Por ahi no corresponde esta excepcion</span>

<span class="nc" id="L65">        return game</span>
    }

    fun getGames(userId: Int, sort: String?, status: Status?, date: Date?): List&lt;Game&gt; {
<span class="nc" id="L69">        val user = RepoUsers.getById(userId).getOrHandle { throw it }</span>
<span class="nc" id="L70">        var games: List&lt;Game&gt; = RepoGames.filter { it.isParticipating(user) }</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">        if(status != null)</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">            games = games.filter { it.status == status }</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">        if(date != null)</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            games = games.filter { it.date == date }</span>

<span class="nc bnc" id="L78" title="All 7 branches missed.">        games = when(sort) {</span>
<span class="nc" id="L79">            &quot;id&quot;              -&gt; games.sortedBy { it.id }</span>
<span class="nc" id="L80">            &quot;date&quot;            -&gt; games.sortedBy { it.date }  // Checkear que Date sea comparable</span>
<span class="nc" id="L81">            &quot;numberOfTowns&quot;   -&gt; games.sortedBy { it.townsAmount }</span>
<span class="nc" id="L82">            &quot;numberOfPlayers&quot; -&gt; games.sortedBy { it.playerAmount }</span>
<span class="nc" id="L83">            else              -&gt; games</span>
        }

<span class="nc" id="L86">        return games</span>
    }

    fun createGame(form: GameForm) {
<span class="nc" id="L90">        val game: Game = Either.fx&lt;CustomException, Game&gt; {</span>
<span class="nc" id="L91">            val users = !form.participantsIds.map { RepoUsers.getById(it) }</span>
<span class="nc" id="L92">                    .sequence(Either.applicative()).fix().map{ it.fix() }</span>

<span class="nc" id="L94">            val townsData: List&lt;TownGeoRef&gt; = !geoRef.requestTownsData(form.provinceName, form.townAmount)</span>

<span class="nc" id="L96">            val towns = !townsData.map { data -&gt;</span>
<span class="nc" id="L97">                topoData.requestElevation(data.coordinates).map { elevation -&gt;</span>
<span class="nc" id="L98">                    Town(data.id, data.name, data.coordinates, elevation.toDouble())</span>
<span class="nc" id="L99">                }</span>
<span class="nc" id="L100">            }.sequence(Either.applicative()).fix().map { it.fix() }</span>
<span class="nc" id="L101">            Game(0,users,  Province(0,form.provinceName, ArrayList(towns)))</span>
<span class="nc" id="L102">        }.getOrHandle { throw it }</span>

<span class="nc" id="L104">        RepoGames.insert(game)</span>
<span class="nc" id="L105">    }</span>

    fun updateTownSpecialization(userId: Int, gameId: Int, townId: Int, newSpecialization: String){
<span class="nc" id="L108">        val game = RepoGames.getById(gameId).getOrHandle { throw it }</span>
<span class="nc" id="L109">        val user = RepoUsers.getById(userId).getOrHandle { throw it }</span>
<span class="nc bnc" id="L110" title="All 3 branches missed.">        when (newSpecialization.toUpperCase()) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            &quot;PRODUCTION&quot; -&gt; game.changeTownSpecialization(user, townId, Production())</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            &quot;DEFENSE&quot;    -&gt; game.changeTownSpecialization(user, townId, Defense())</span>
        }
<span class="nc" id="L114">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>